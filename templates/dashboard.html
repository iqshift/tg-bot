<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>لوحة التحكم | بوت المحميل الذكي</title>
    <!-- خط Cairo العربي الحديث -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;500;600;700;800&display=swap"
        rel="stylesheet">
    <!-- Font Awesome للأيقونات -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root {
            /* نظام الألوان المقترح */
            --primary: #3B82F6;
            --primary-light: #60A5FA;
            --primary-dark: #2563EB;
            --secondary: #0EA5E9;
            --bg-body: #0B1220;
            --bg-sidebar: #0F172A;
            --bg-card: #111827;
            --bg-card-hover: #1E293B;
            --border: #1E293B;
            --text-main: #F8FAFC;
            --text-muted: #94A3B8;
            --success: #10B981;
            --error: #EF4444;
            --warning: #F59E0B;
            --glass: rgba(17, 24, 39, 0.7);

            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            --sidebar-width: 280px;
            --sidebar-collapsed-width: 80px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Cairo', sans-serif;
            background-color: var(--bg-body);
            color: var(--text-main);
            overflow-x: hidden;
            line-height: 1.6;
        }

        /* المظهر الزجاجي */
        .glass {
            background: var(--glass);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid var(--border);
        }

        /* الهيكل العام */
        .wrapper {
            display: flex;
            min-height: 100vh;
        }

        /* Sidebar الجانبي */
        .sidebar {
            width: var(--sidebar-width);
            background-color: var(--bg-sidebar);
            border-left: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            position: fixed;
            height: 100vh;
            right: 0;
            top: 0;
            z-index: 100;
            transition: var(--transition);
        }

        .sidebar-header {
            padding: 24px;
            display: flex;
            align-items: center;
            gap: 12px;
            border-bottom: 1px solid var(--border);
        }

        .sidebar-header .logo-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            color: white;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }

        .sidebar-header h1 {
            font-size: 18px;
            font-weight: 700;
            white-space: nowrap;
        }

        .sidebar-menu {
            flex: 1;
            padding: 20px 12px;
            overflow-y: auto;
        }

        .menu-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            border-radius: 12px;
            color: var(--text-muted);
            text-decoration: none;
            margin-bottom: 4px;
            transition: var(--transition);
            cursor: pointer;
            border: none;
            background: none;
            width: 100%;
            text-align: right;
            font-family: inherit;
            font-size: 15px;
        }

        .menu-item i {
            width: 20px;
            font-size: 18px;
        }

        .menu-item:hover {
            background-color: rgba(59, 130, 246, 0.1);
            color: var(--primary-light);
            padding-right: 20px;
        }

        .menu-item.active {
            background: linear-gradient(to left, rgba(59, 130, 246, 0.2), transparent);
            color: var(--primary);
            font-weight: 600;
            position: relative;
        }

        .menu-item.active::after {
            content: '';
            position: absolute;
            right: 0;
            top: 15%;
            height: 70%;
            width: 4px;
            background-color: var(--primary);
            border-radius: 4px 0 0 4px;
        }

        .sidebar-footer {
            padding: 20px;
            border-top: 1px solid var(--border);
        }

        .user-profile {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 8px;
            border-radius: 12px;
            background: rgba(30, 41, 59, 0.5);
        }

        .user-profile img {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            object-fit: cover;
        }

        .user-info .name {
            font-size: 14px;
            font-weight: 600;
            display: block;
        }

        .user-info .role {
            font-size: 11px;
            color: var(--text-muted);
        }

        /* المحتوى الرئيسي */
        .main-container {
            flex: 1;
            margin-right: var(--sidebar-width);
            transition: var(--transition);
            padding: 24px;
        }

        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 32px;
        }

        .page-title h2 {
            font-size: 24px;
            font-weight: 800;
        }

        .page-title .breadcrumb {
            font-size: 13px;
            color: var(--text-muted);
            margin-top: 4px;
        }

        .header-actions {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .status-badge {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 14px;
            border-radius: 30px;
            background: rgba(16, 185, 129, 0.1);
            color: var(--success);
            font-size: 13px;
            font-weight: 600;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: var(--success);
            box-shadow: 0 0 8px var(--success);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% {
                transform: scale(1);
                opacity: 1;
            }

            50% {
                transform: scale(1.5);
                opacity: 0.5;
            }

            100% {
                transform: scale(1);
                opacity: 1;
            }
        }

        /* بطاقات الإحصائيات */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 20px;
            margin-bottom: 32px;
        }

        .stat-card {
            padding: 24px;
            border-radius: 20px;
            transition: var(--transition);
            position: relative;
            overflow: hidden;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            border-color: var(--primary);
            box-shadow: 0 10px 30px -10px rgba(0, 0, 0, 0.5);
        }

        .stat-icon {
            width: 50px;
            height: 50px;
            border-radius: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 22px;
            margin-bottom: 16px;
        }

        .stat-value {
            font-size: 32px;
            font-weight: 800;
            display: block;
            margin-bottom: 4px;
        }

        .stat-label {
            font-size: 14px;
            color: var(--text-muted);
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .growth {
            font-size: 12px;
            font-weight: 700;
            padding: 2px 8px;
            border-radius: 4px;
        }

        .growth.up {
            background: rgba(16, 185, 129, 0.1);
            color: var(--success);
        }

        .growth.down {
            background: rgba(239, 68, 68, 0.1);
            color: var(--error);
        }

        /* الأقسام */
        .section {
            display: none;
            animation: fadeIn 0.4s ease-out;
        }

        .section.active {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* البطاقات والشبكات */
        .card {
            padding: 24px;
            border-radius: 20px;
            margin-bottom: 24px;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .card-title {
            font-size: 18px;
            font-weight: 700;
        }

        /* الجداول والقوائم */
        .table-responsive {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            text-align: right;
        }

        th {
            padding: 14px 16px;
            font-size: 13px;
            font-weight: 600;
            color: var(--text-muted);
            border-bottom: 1px solid var(--border);
        }

        td {
            padding: 16px;
            font-size: 14px;
            border-bottom: 1px solid var(--border);
        }

        tr:hover td {
            background-color: rgba(255, 255, 255, 0.02);
        }

        /* الأزرار */
        .btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 10px 20px;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            border: none;
            font-family: inherit;
            font-size: 14px;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3);
        }

        .btn-primary:hover {
            box-shadow: 0 6px 20px rgba(59, 130, 246, 0.4);
            transform: scale(1.02);
        }

        .btn-danger {
            background: rgba(239, 68, 68, 0.1);
            color: var(--error);
            border: 1px solid rgba(239, 68, 68, 0.2);
        }

        .btn-danger:hover {
            background: var(--error);
            color: white;
        }

        .btn-outline {
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text-muted);
        }

        .btn-outline:hover {
            border-color: var(--primary);
            color: var(--primary);
        }

        /* النماذج (Forms) */
        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-size: 14px;
            font-weight: 600;
            color: var(--text-muted);
        }

        input[type="text"],
        textarea {
            width: 100%;
            background-color: rgba(15, 23, 42, 0.5);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 12px 16px;
            color: var(--text-main);
            font-family: inherit;
            transition: var(--transition);
        }

        input:focus,
        textarea:focus {
            outline: none;
            border-color: var(--primary);
            background-color: rgba(15, 23, 42, 0.8);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.15);
        }

        textarea {
            resize: vertical;
        }

        /* التنبيهات (Flash Messages) */
        #flash-container {
            position: fixed;
            top: 24px;
            left: 24px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .toast {
            padding: 16px 24px;
            border-radius: 12px;
            background: var(--bg-card);
            border-right: 4px solid var(--primary);
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.4);
            animation: slideIn 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            align-items: center;
            gap: 12px;
            min-width: 300px;
        }

        @keyframes slideIn {
            from {
                transform: translateX(-100%);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .toast.success {
            border-right-color: var(--success);
        }

        .toast.error {
            border-right-color: var(--error);
        }

        /* خاصية اللوحة الحالية للمستخدمين */
        .user-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 16px;
        }

        .user-card {
            padding: 16px;
            border-radius: 16px;
            display: flex;
            align-items: center;
            gap: 16px;
            text-decoration: none;
            color: inherit;
            transition: var(--transition);
        }

        .user-card:hover {
            background-color: var(--bg-card-hover);
            transform: scale(1.02);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .user-avatar {
            width: 54px;
            height: 54px;
            border-radius: 14px;
            background: linear-gradient(135deg, var(--bg-sidebar), var(--bg-body));
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            font-weight: 700;
            color: var(--primary);
            border: 1px solid var(--border);
            overflow: hidden;
        }

        .user-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .user-details {
            flex: 1;
            min-width: 0;
        }

        .user-name {
            display: block;
            font-weight: 700;
            font-size: 15px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .user-handle {
            display: block;
            font-size: 13px;
            color: var(--text-muted);
        }

        .user-status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }

        .user-status-dot.active {
            background-color: var(--success);
        }

        .user-status-dot.banned {
            background-color: var(--error);
        }

        /* الشاشات الصغيرة */
        @media (max-width: 1024px) {
            .sidebar {
                width: var(--sidebar-collapsed-width);
            }

            .sidebar-header h1,
            .sidebar-header .logo-text,
            .menu-item span,
            .user-info {
                display: none;
            }

            .main-container {
                margin-right: var(--sidebar-collapsed-width);
            }

            .menu-item {
                justify-content: center;
                padding: 12px;
            }

            .menu-item i {
                margin: 0;
                font-size: 20px;
            }
        }

        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(100%);
            }

            .sidebar.mobile-open {
                transform: translateX(0);
                width: var(--sidebar-width);
            }

            .sidebar.mobile-open .menu-item span {
                display: inline;
            }

            .main-container {
                margin-right: 0;
            }

            .page-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 16px;
            }

            .header-actions {
                width: 100%;
                justify-content: space-between;
            }
        }
    </style>
</head>

<body>

    <!-- التنبيهات -->
    <div id="flash-container">
        {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
        {% for category, message in messages %}
        <div class="toast {{ category }}">
            <i
                class="fa-solid {% if category == 'success' %}fa-circle-check{% else %}fa-circle-exclamation{% endif %}"></i>
            <span>{{ message }}</span>
        </div>
        {% endfor %}
        {% endif %}
        {% endwith %}
    </div>

    <div class="wrapper">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <div class="logo-icon">
                    <i class="fa-solid fa-bolt"></i>
                </div>
                <div class="logo-text">
                    <h1>بوت التحميل</h1>
                </div>
            </div>

            <nav class="sidebar-menu">
                <button class="menu-item active" onclick="showSection('overview', this)">
                    <i class="fa-solid fa-house"></i>
                    <span>الرئيسية</span>
                </button>
                <button class="menu-item" onclick="showSection('users', this)">
                    <i class="fa-solid fa-users"></i>
                    <span>المستخدمين</span>
                </button>
                <button class="menu-item" onclick="showSection('settings', this)">
                    <i class="fa-solid fa-sliders"></i>
                    <span>الإعدادات</span>
                </button>
                <button class="menu-item" onclick="showSection('channels', this)">
                    <i class="fa-solid fa-bullhorn"></i>
                    <span>القنوات</span>
                </button>
                <button class="menu-item" onclick="showSection('errors-section', this)" id="nav-errors">
                    <i class="fa-solid fa-bug"></i>
                    <span>سجل الأخطاء</span>
                </button>
                <button class="menu-item" onclick="showSection('proxies-section', this)">
                    <i class="fa-solid fa-shield-halved"></i>
                    <span>البروكسيات</span>
                </button>
            </nav>

            <div class="sidebar-footer">
                <div class="user-profile">
                    <img src="https://api.dicebear.com/6.x/bottts/svg?seed=Admin" alt="Admin">
                    <div class="user-info">
                        <span class="name">المدير العام</span>
                        <span class="role">مسؤول النظام</span>
                    </div>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-container">
            <header class="page-header">
                <div class="page-title">
                    <h2 id="pageTitleDisplay">لوحة التحكم</h2>
                    <div class="breadcrumb">الرئيسية / الإحصائيات</div>
                </div>
                <div class="header-actions">
                    <div class="status-badge">
                        <div class="status-dot"></div>
                        <span>النظام يعمل</span>
                    </div>
                    <button class="btn btn-outline" onclick="location.reload()">
                        <i class="fa-solid fa-rotate"></i>
                    </button>
                </div>
            </header>

            <!-- بطاقات الإحصائيات -->
            <div class="stats-grid">
                <div class="stat-card glass">
                    <div class="stat-icon" style="background: rgba(59, 130, 246, 0.1); color: var(--primary);">
                        <i class="fa-solid fa-user-plus"></i>
                    </div>
                    <span class="stat-value">{{ stats.total_users }}</span>
                    <span class="stat-label">المستخدمين <span class="growth up">إجمالي</span></span>
                </div>
                <div class="stat-card glass">
                    <div class="stat-icon" style="background: rgba(16, 185, 129, 0.1); color: var(--success);">
                        <i class="fa-solid fa-chart-line"></i>
                    </div>
                    <span class="stat-value">{{ stats.active_24h }}</span>
                    <span class="stat-label">إجمالي النشاط <span class="growth up">+12%</span></span>
                </div>
                <div class="stat-card glass">
                    <div class="stat-icon" style="background: rgba(239, 68, 68, 0.1); color: var(--error);">
                        <i class="fa-solid fa-user-slash"></i>
                    </div>
                    <span class="stat-value">{{ stats.banned_users }}</span>
                    <span class="stat-label">محظورين <span class="growth down">مطرود</span></span>
                </div>
                <div class="stat-card glass">
                    <div class="stat-icon" style="background: rgba(245, 158, 11, 0.1); color: var(--warning);">
                        <i class="fa-solid fa-triangle-exclamation"></i>
                    </div>
                    <span class="stat-value" id="stats-errors-count">{{ stats.total_errors }}</span>
                    <span class="stat-label">أخطاء برمجية <span class="growth down">حرجة</span></span>
                </div>
            </div>

            <div class="content-body">

                <!-- Overview: الإرسال الجماعي -->
                <div id="overview" class="section active">
                    <div class="card glass">
                        <div class="card-header">
                            <h3 class="card-title"><i class="fa-solid fa-paper-plane"
                                    style="margin-left: 8px;"></i>إرسال رسالة جماعية (Broadcast)</h3>
                        </div>
                        <form action="/broadcast" method="POST" id="broadcast-form">
                            <div class="form-group">
                                <label>عنوان الرسالة (اختياري)</label>
                                <input type="text" name="title" placeholder="مثلاً: تحديث جديد للبوت">
                            </div>
                            <div class="form-group">
                                <label>محتوى الرسالة</label>
                                <textarea name="message" rows="5" placeholder="اكتب ما تريد إرساله لجميع المستخدمين..."
                                    required></textarea>
                            </div>
                            <div style="display: flex; justify-content: flex-end;">
                                <button type="submit" class="btn btn-primary">
                                    <i class="fa-solid fa-share-all"></i>
                                    بدء الإرسال للجميع
                                </button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Users Section -->
                <div id="users" class="section">
                    <div class="card glass">
                        <div class="card-header">
                            <h3 class="card-title">إدارة المستخدمين</h3>
                            <div class="header-actions">
                                <input type="text" id="user-search" placeholder="بحث باسم المستخدم..."
                                    style="margin: 0; width: 200px; padding: 6px 12px;">
                            </div>
                        </div>
                        <div class="user-grid">
                            {% for user in users %}
                            <a href="/chat/{{ user.user_id }}" target="_blank" class="user-card glass">
                                <div class="user-avatar">
                                    {% if user.photo_url %}
                                    <img src="{{ user.photo_url }}" alt="{{ user.first_name }}"
                                        onerror="this.parentNode.innerText='{{ user.first_name[0] }}';">
                                    {% else %}
                                    {{ user.first_name[0] if user.first_name else '؟' }}
                                    {% endif %}
                                </div>
                                <div class="user-details">
                                    <span class="user-name">{{ user.first_name }}</span>
                                    <span class="user-handle">@{{ user.username if user.username else user.user_id
                                        }}</span>
                                </div>
                                <div class="user-status-dot {% if user.is_banned %}banned{% else %}active{% endif %}">
                                </div>
                            </a>
                            {% endfor %}
                        </div>
                    </div>
                </div>

                <!-- Settings Section -->
                <div id="settings" class="section">
                    <div class="card glass">
                        <div class="card-header">
                            <h3 class="card-title">الإعدادات العامة للرسائل</h3>
                        </div>
                        <form action="/update_settings" method="POST">
                            <div class="stats-grid" style="grid-template-columns: 1fr 1fr;">
                                <div class="form-group">
                                    <label>رسالة الترحيب (/start)</label>
                                    <textarea name="welcome_msg" rows="3">{{ settings.welcome_msg }}</textarea>
                                </div>
                                <div class="form-group">
                                    <label>رسالة المساعدة (/help)</label>
                                    <textarea name="help_msg" rows="3">{{ settings.help_msg }}</textarea>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>رسالة الاشتراك الإجباري</label>
                                <textarea name="msg_force_sub" rows="3">{{ settings.msg_force_sub }}</textarea>
                                <small style="color: var(--text-muted);">استخدم {channels} لوضع قائمة القنوات
                                    تلقائياً.</small>
                            </div>
                            <div class="form-row" style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                                <div class="form-group">
                                    <label>تذييل الفيديو (Caption)</label>
                                    <input type="text" name="msg_caption" value="{{ settings.msg_caption }}">
                                </div>
                            </div>
                            <div style="display: flex; justify-content: flex-end;">
                                <button class="btn btn-primary">حفظ التغييرات</button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Channels Section -->
                <div id="channels" class="section">
                    <div class="card glass">
                        <div class="card-header">
                            <h3 class="card-title">التحقق من الاشتراك</h3>
                        </div>
                        <form action="/add_channel" method="POST"
                            style="background: rgba(15, 23, 42, 0.4); padding: 20px; border-radius: 16px; margin-bottom: 24px;">
                            <label>إضافة قناة جديدة</label>
                            <div style="display: flex; gap: 12px;">
                                <input type="text" name="channel_name" placeholder="@channel_username"
                                    style="margin: 0;">
                                <button class="btn btn-primary">إضافة</button>
                            </div>
                        </form>

                        <div class="table-responsive">
                            <table>
                                <thead>
                                    <tr>
                                        <th>اسم القناة</th>
                                        <th>الحالة</th>
                                        <th style="width: 100px;">الإجراء</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for channel in channels_list %}
                                    <tr>
                                        <td><span style="color: var(--primary); font-weight: 700;">{{ channel }}</span>
                                        </td>
                                        <td><span class="status-badge"
                                                style="background: rgba(16, 185, 129, 0.05); width: fit-content; padding: 4px 12px;">نشطة</span>
                                        </td>
                                        <td>
                                            <form action="/delete_channel" method="POST" style="margin: 0;">
                                                <input type="hidden" name="channel_name" value="{{ channel }}">
                                                <button class="btn btn-danger"
                                                    style="padding: 6px 12px; font-size: 12px;">حذف</button>
                                            </form>
                                        </td>
                                    </tr>
                                    {% else %}
                                    <tr>
                                        <td colspan="3"
                                            style="text-align: center; color: var(--text-muted); padding: 40px;">لا توجد
                                            قنوات مفعلة حالياً</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Error Logs Section -->
                <div id="errors-section" class="section">
                    <div class="card glass">
                        <div class="card-header">
                            <h3 class="card-title">سجل الأخطاء التقنية</h3>
                            <form action="/errors/clear" method="POST" style="margin:0;">
                                <button class="btn btn-danger" onclick="return confirm('هل أنت متأكد؟')">
                                    <i class="fa-solid fa-trash-can"></i> مسح السجل
                                </button>
                            </form>
                        </div>
                        <div class="table-responsive">
                            <table>
                                <thead>
                                    <tr>
                                        <th>التوقيت</th>
                                        <th>المنصة</th>
                                        <th>المستخدم</th>
                                        <th>الخطأ</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for err in errors %}
                                    <tr>
                                        <td style="color: var(--text-muted); font-size: 13px;">{{ err.timestamp }}</td>
                                        <td><span
                                                style="background: rgba(59, 130, 246, 0.1); padding: 4px 10px; border-radius: 8px;">{{
                                                err.platform }}</span></td>
                                        <td>{{ err.user_id or 'نظام' }}</td>
                                        <td>
                                            <details>
                                                <summary style="cursor: pointer; color: var(--error);">تحليل الخطأ
                                                </summary>
                                                <pre
                                                    style="margin-top: 10px; background: #000; padding: 12px; border-radius: 8px; font-size: 12px; color: #ff8a80; overflow-x: auto;">{{ err.error_msg }}</pre>
                                            </details>
                                        </td>
                                    </tr>
                                    {% else %}
                                    <tr>
                                        <td colspan="4"
                                            style="text-align: center; color: var(--success); padding: 40px;">✅ لا توجد
                                            أخطاء حالياً</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Proxies Section -->
                <div id="proxies-section" class="section">
                    <div class="card glass">
                        <div class="card-header">
                            <h3 class="card-title">إدارة تدوير البروكسيات</h3>
                            <div style="display: flex; gap: 8px;">
                                <button class="btn btn-outline" onclick="checkCurrentProxies()" id="btn-check-current">
                                    <i class="fa-solid fa-magnifying-glass"></i> فحص القائمة
                                </button>
                                <button class="btn btn-danger" onclick="clearAllProxies()">
                                    <i class="fa-solid fa-broom"></i> مسح الكل
                                </button>
                            </div>
                        </div>

                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px;">
                            <div>
                                <label>إضافة بروكسيات جديدة (Line by Line)</label>
                                <textarea id="new-proxies-input" rows="8"
                                    placeholder="socks5://user:pass@host:port&#10;http://host:port"></textarea>
                                <button class="btn btn-primary" onclick="addAndCheckProxies()" id="btn-add-check"
                                    style="width: 100%; margin-top: 12px;">
                                    <i class="fa-solid fa-plus"></i> إضافة وفحص الشاغل
                                </button>
                            </div>
                            <div
                                style="background: rgba(15, 23, 42, 0.4); border-radius: 20px; padding: 20px; border: 1px solid var(--border);">
                                <label>القائمة الحالية (<span id="proxies-count-badge">0</span>)</label>
                                <div id="proxy-current-list"
                                    style="max-height: 250px; overflow-y: auto; font-family: monospace; font-size: 13px; color: var(--primary-light);">
                                    جاري جلب البيانات...
                                </div>
                            </div>
                        </div>
                        <div id="proxy-result-box" style="margin-top: 20px;"></div>
                    </div>
                </div>

            </div>
        </main>
    </div>

    <!-- JavaScript الأصلي مع تحسينات طفيفة للتوافق -->
    <script>
        function showSection(id, element) {
            // إخفاء الكل
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            // عرض المطلوب
            const target = document.getElementById(id);
            if (target) target.classList.add('active');

            // تحديث العنوان
            const titles = {
                'overview': 'الرئيسية / الإحصائيات',
                'users': 'إدارة المستخدمين',
                'settings': 'الإعدادات العامة',
                'channels': 'الاشتراك الإجباري',
                'errors-section': 'سجل الأخطاء التقنية',
                'proxies-section': 'إدارة البروكسيات'
            };
            document.getElementById('pageTitleDisplay').innerText = titles[id] || 'لوحة التحكم';

            // تحديث الحالة النشطة في القائمة
            if (element) {
                document.querySelectorAll('.menu-item').forEach(m => m.classList.remove('active'));
                element.classList.add('active');
            }
        }

        // إخفاء التنبيهات تلقائياً
        setTimeout(() => {
            const toasts = document.querySelectorAll('.toast');
            toasts.forEach(t => {
                t.style.opacity = '0';
                t.style.transform = 'translateX(-20px)';
                setTimeout(() => t.remove(), 400);
            });
        }, 5000);

        // البحث في المستخدمين
        document.getElementById('user-search')?.addEventListener('input', function (e) {
            const q = e.target.value.toLowerCase();
            document.querySelectorAll('.user-card').forEach(card => {
                const name = card.querySelector('.user-name').innerText.toLowerCase();
                card.style.display = name.includes(q) ? 'flex' : 'none';
            });
        });

        /* ═══ وظائف البروكسي (نفس المنطق السابق) ════════════════════════════════ */

        async function fetchProxies() {
            try {
                const r = await fetch('/proxies/list');
                const d = await r.json();
                renderProxyList(d.proxies);
                document.querySelectorAll('#proxies-count-badge').forEach(b => b.innerText = d.count);
                if (d.count > 0) {
                    document.getElementById('nav-errors').style.color = '';
                }
            } catch (e) { console.error(e); }
        }

        function renderProxyList(list) {
            const container = document.getElementById('proxy-current-list');
            if (!list || list.length === 0) {
                container.innerHTML = '<div style="padding:20px;text-align:center;color:var(--text-muted)">لا توجد بروكسيات حالياً</div>';
                return;
            }
            container.innerHTML = list.map(p => `
                <div style="padding:6px 10px; border-bottom:1px solid var(--border); display:flex; justify-content:space-between; align-items:center;">
                    <span>${p}</span>
                    <i class="fa-solid fa-check-circle" style="color:var(--success); font-size:12px;"></i>
                </div>
            `).join('');
        }

        async function checkCurrentProxies() {
            const btn = document.getElementById('btn-check-current');
            const oldHtml = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> جاري الفحص...';

            try {
                const r = await fetch('/proxies/check_current', { method: 'POST' });
                const d = await r.json();
                showProxyResult(`تم فحص الكل. الشغال: ${d.working}, الميت: ${d.dead}`, d.ok);
                fetchProxies();
            } finally {
                btn.disabled = false;
                btn.innerHTML = oldHtml;
            }
        }

        async function addAndCheckProxies() {
            const input = document.getElementById('new-proxies-input').value.trim();
            if (!input) return alert('الرجاء الصاق البروكسيات أولاً');

            const btn = document.getElementById('btn-add-check');
            const oldHtml = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> جاري فحص الإضافات...';

            const formData = new FormData();
            formData.append('new_proxies', input);

            try {
                const r = await fetch('/proxies/add_and_check', { method: 'POST', body: formData });
                const d = await r.json();
                showProxyResult(`فحصنا ${d.checked} بروكسي. أضفنا ${d.working} عاملة. الإجمالي الآن: ${d.total_after}`, d.ok);
                document.getElementById('new-proxies-input').value = '';
                fetchProxies();
            } finally {
                btn.disabled = false;
                btn.innerHTML = oldHtml;
            }
        }

        async function clearAllProxies() {
            if (!confirm('هل أنت متأكد من مسح جميع البروكسيات؟')) return;
            await fetch('/proxies/clear', { method: 'POST' });
            fetchProxies();
            showProxyResult('تم مسح القائمة بنجاح', true);
        }

        function showProxyResult(msg, success) {
            const box = document.getElementById('proxy-result-box');
            box.innerHTML = `<div class="toast ${success ? 'success' : 'error'}" style="position:static; width:100%; margin-bottom:0;">
                <i class="fa-solid fa-info-circle"></i> ${msg}
            </div>`;
        }

        // جلب البيانات عند التحميل
        window.addEventListener('load', () => {
            fetchProxies();
        });
    </script>
</body>

</html>